# K8S中集成Apollo配置中心

* 运维八荣八耻
  * 以可配置为荣，以硬编码为耻
  * 以互备为荣，以单点为耻
  * 以随时重启为荣，以不能迁移为耻
  * 以整体交付为荣，以部分交付为耻
  * 以无状态为荣，以有状态为耻
  * 以标准化为荣，以特殊化为耻
  * 以自动化工具为荣，以手动+人肉为耻
  * 以无人值守为荣，以人工介入为耻
* 前面交付进K8S集群的两个dubbo微服务和一个monitor，最大的问题是它们的配置写死在容器里了

## 配置中心的概述

* 配置有多种形态
  * 程序内部硬编码、配置文件、环境变量、启动参数、基于数据库
* 集中管理应用程序配置的“中心”
* 常见的配置中心
  * K8S ConfigMap：K8S的一种标准资源，专门用来集中管理应用的配置
  * Apollo：携程框架部门开源的，分布式配置中心

## 实战K8S的配置中心-ConfigMap

### ConfigMap管理应用配置

```shell
# 拆分环境
HDSS7-11.host.com		zk1.od.com(Test环境) 	192.168.0.11
HDSS7-12.host.com   zk2.od.com(Prod环境)  192.168.0.12

# dashboard上将dubbo-demo-service、dubbo-demo-consumer、dubbo-monitor设置scale为0

# 拆分zk集群
## 停止21上zk
[root@hdss7-21 bin]# /opt/zookeeper/bin/zkServer.sh stop
## 11、12上
[root@hdss7-12 bin]# /opt/zookeeper/bin/zkServer.sh stop
[root@hdss7-11 logs]# ps aux|grep zoo
root     24934  0.0  0.0 112824   980 pts/0    S+   13:12   0:00 grep --color=auto zoo
[root@hdss7-11 zookeeper]# cd /data/zookeeper
[root@hdss7-11 zookeeper]# rm -rf data/*
[root@hdss7-11 zookeeper]# rm -rf logs/*
[root@hdss7-11 zookeeper]# cd /opt/zookeeper/conf/
[root@hdss7-11 conf]# vi zoo.cfg
tickTime=2000
initLimit=10
syncLimit=5
dataDir=/data/zookeeper/data
dataLogDir=/data/zookeeper/logs
clientPort=2181
[root@hdss7-11 conf]# ../bin/zkServer.sh start
[root@hdss7-11 conf]# ../bin/zkServer.sh status
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/bin/../conf/zoo.cfg
Mode: standalone

# 200上
[root@hdss7-200 dubbo-monitor]# cd /data/k8s-yaml/dubbo-monitor
[root@hdss7-200 dubbo-monitor]# vi /data/k8s-yaml/dubbo-monitor/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dubbo-monitor-cm
  namespace: infra
data:
  dubbo.properties: |
    dubbo.container=log4j,spring,registry,jetty
    dubbo.application.name=simple-monitor
    dubbo.application.owner=OldboyEdu
    dubbo.registry.address=zookeeper://zk1.od.com:2181
    dubbo.protocol.port=20880
    dubbo.jetty.port=8080
    dubbo.jetty.directory=/dubbo-monitor-simple/monitor
    dubbo.charts.directory=/dubbo-monitor-simple/charts
    dubbo.statistics.directory=/dubbo-monitor-simple/statistics
    dubbo.log4j.file=/dubbo-monitor-simple/logs/dubbo-monitor.log
    dubbo.log4j.level=WARN
    
[root@hdss7-200 dubbo-monitor]# vi /data/k8s-yaml/dubbo-monitor/deployment2.yaml    

kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: dubbo-monitor
  namespace: infra
  labels: 
    name: dubbo-monitor
spec:
  replicas: 1
  selector:
    matchLabels: 
      name: dubbo-monitor
  template:
    metadata:
      labels: 
        app: dubbo-monitor
        name: dubbo-monitor
    spec:
      containers:
      - name: dubbo-monitor
        image: harbor.od.com/infra/dubbo-monitor:latest
        ports:
        - containerPort: 8080
          protocol: TCP
        - containerPort: 20880
          protocol: TCP
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - name: configmap-volume
            mountPath: /dubbo-monitor-simple/conf
      volumes:
        - name: configmap-volume
          configMap:
            name: dubbo-monitor-cm
      imagePullSecrets:
      - name: harbor
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext: 
        runAsUser: 0
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate: 
      maxUnavailable: 1
      maxSurge: 1
  revisionHistoryLimit: 7
  progressDeadlineSeconds: 600

[root@hdss7-200 dubbo-monitor]# vimdiff deployment.yaml deployment2.yaml
[root@hdss7-200 dubbo-monitor]# mv deployment2.yaml deployment.yaml

# 21上
[root@hdss7-21 bin]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/configmap.yaml
```

![image-20200823133052871](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133052871.png)

```shell
[root@hdss7-21 bin]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/deployment.yaml
```

![image-20200823133340714](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133340714.png)

![image-20200823133543522](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133543522.png)

![image-20200823133637250](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133637250.png)

![image-20200823133845102](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133845102.png)

* dashboard中修改ConfigMap，zookeeper://zk1.od.com:2181为zookeeper://zk2.od.com:2181
* dashboard 容器组中删除dubbo-monitor

![image-20200823134108383](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823134108383.png)

## 排查页面访问不了

* 大概率是集群中网络问题，首先看ingress、删除对应的pod，然后重新创建pod
* 查看各组件是否启动成功、查看对应组件日志

```shell
# 排查页面访问不了
tail -fn 200 /var/log/traefik_access.log | grep -i dubbo-monitor
```

![image-20200823134903897](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823134903897.png)

![image-20200823135316420](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823135316420.png)

![image-20200823135821411](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823135821411.png)

![image-20200823140533432](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823140533432.png)

* etcd中key添加上

![image-20200823140739137](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823140739137.png)

![image-20200823140930382](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823140930382.png)

![image-20200823141133417](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823141133417.png)

## Dubbo微服务

* 注册中心zookeeper（集群）
* 提供者（集群）
* 消费者（集群）
* 监控（dubbo-monitor/dubbo-admin）

## 在K8S内交付dubbo微服务的步骤

1. 有可用的K8S集群
2. 部署zk集群（通常放在K8S集群外，有状态）
3. 部署Jenkins（以容器的形式交付在K8S集群内）
   * root、时区、ssh-key、docker客户端、harbor连接配置
     * docker客户端可以和宿主机的docker服务端通信，拉取镜像
4. 部署maven软件
5. 制作dubbo微服务的底包
6. 配置Jenkins持续构建（CI）流水线
7. 使用流水线构建项目，查看harbor仓库
8. 使用资源配置清单，交付项目到K8S集群

* dubbo的提供者和消费者通过pod的ip进行通信

```shell
[root@hdss7-22 ~]# cd /opt/kubernetes/server/bin/conf/
[root@hdss7-22 ~]# cat kube-proxy.kubeconfig
[root@hdss7-22 conf]# kubectl create cm kubelet-cm --from-file=./kubelet.kubeconfig
configmap/kubelet-cm created
```

![image-20200823164038587](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823164038587.png)

```shell
[root@hdss7-22 conf]# kubectl get cm kubelet-cm -o yaml
```

## Apollo配置中心介绍

* ConfigService提供配置的读取、推送等功能，服务对象是Apollo客户端
* Admin Service提供配置的修改、发布等功能，服务对象是Apollo Portal（管理界面）
* Config Service和Admin Service都是多实例、无状态部署，所以需要将自己注册到Eureka中并保持心跳
* 在Eureka之上架了一层Meta Server用于封装Eureka的服务发现接口
* Client通过域名访问Meta Server获取Config Service服务列表（IP + Port），而后直接通过IP + Port访问服务，同时在Client侧会做load balance、错误重试
* Portal通过域名访问Meta Server获取Admin Service服务列表（IP + Port），而后直接通过IP + Port访问服务，同时在Portal侧会做load balance、错误重试

![image-20200823164706210](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823164706210.png)

![image-20200823164905952](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823164905952.png)

## 实战交付Apollo配置中心组件

### 安装MySQL

* 卸载mysql

  ```shell
  [root@hdss7-11 my.cnf.d]# rpm -qa |grep -i mysql
  mysql-community-common-5.7.30-1.el7.x86_64
  mysql-community-server-5.7.30-1.el7.x86_64
  mysql-community-libs-5.7.30-1.el7.x86_64
  mysql-community-libs-compat-5.7.30-1.el7.x86_64
  mysql57-community-release-el7-11.noarch
  mysql-community-client-5.7.30-1.el7.x86_64
  # 依次删除
  yum remove mysql-community-server-5.7.30-1.el7.x86_64
  ...
  # 依次删除
  [root@hdss7-11 my.cnf.d]# find / -name mysql
  /etc/selinux/targeted/active/modules/100/mysql
  /etc/selinux/targeted/tmp/modules/100/mysql
  /var/lib/mysql
  /var/lib/mysql/mysql
  /usr/share/mysql
  [root@hdss7-11 my.cnf.d]# rm -rf /etc/selinux/targeted/active/modules/100/mysql
  ...
  # 删除
  [root@hdss7-11 my.cnf.d]# rm -rf /etc/my.cnf
  [root@hdss7-11 my.cnf.d]# rm -rf /var/log/mysqld.log
  ```

* 安装数据库

  ```shell
  # 11上
  [root@hdss7-11 ~]# vi /etc/yum.repos.d/MariaDB.repo
  [mariadb]
  name = MariaDB
  baseurl = https://mirrors.ustc.edu.cn/mariadb/yum/10.1/centos7-amd64/
  gpgkey=https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB
  gpgcheck=1
  # 导入GPG-KEY
  [root@hdss7-11 ~]# rpm --import https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB
  [root@hdss7-11 ~]# yum list mariadb --show-duplicates
  [root@hdss7-11 ~]# yum makecache
  [root@hdss7-11 ~]# yum list mariadb-server --show-duplicates
  [root@hdss7-11 ~]# yum install mariadb-server -y
  [root@hdss7-11 ~]# vi /etc/my.cnf.d/server.cnf
  [mysqld]
  character_set_server = utf8mb4
  collation_server = utf8mb4_general_ci
  init_connect = "SET NAMES 'utf8mb4'"
  [root@hdss7-11 my.cnf.d]# vi /etc/my.cnf.d/mysql-clients.cnf
  [mysql]
  default-character-set = utf8mb4
  [root@hdss7-11 my.cnf.d]# systemctl start mariadb
  [root@hdss7-11 my.cnf.d]# systemctl enable mariadb
  [root@hdss7-11 my.cnf.d]# mysqladmin -uroot password
  New password: root
  Confirm new password: root
  [root@hdss7-11 my.cnf.d]# mysql -uroot -p
  MariaDB [(none)]> \s
  Server characterset:	utf8mb4
  Db     characterset:	utf8mb4
  Client characterset:	utf8mb4
  Conn.  characterset:	utf8mb4
  MariaDB [(none)]> show databases;
  MariaDB [(none)]> drop database test;
  [root@hdss7-11 my.cnf.d]# ps aux|grep mysqld
  mysql    16678  0.1  7.1 807048 135044 ?       Ssl  17:24   0:00 /usr/sbin/mysqld
  root     16883  0.0  0.0 112824   980 pts/0    R+   17:28   0:00 grep --color=auto mysqld
  [root@hdss7-11 my.cnf.d]# ps aux|grep maria
  root     16893  0.0  0.0 112824   980 pts/0    S+   17:28   0:00 grep --color=auto maria
  [root@hdss7-11 my.cnf.d]# netstat -luntp|grep 3306
  tcp6       0      0 :::3306                 :::*                    LISTEN      16678/mysqld
  # apollo官方sql初始化配置文件 1.5.1版本
  https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/db/migration/configdb/V1.0.0__initialization.sql
  [root@hdss7-11 ~]# wget https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/db/migration/configdb/V1.0.0__initialization.sql -O apolloconfig.sql
  [root@hdss7-11 ~]# mysql -uroot -p < apolloconfig.sql
  [root@hdss7-11 ~]# mysql -uroot -p
  MariaDB [(none)]> show databaes;
  MariaDB [(none)]> use ApolloConfigDB
  MariaDB [ApolloConfigDB]> show tables;
  MariaDB [ApolloConfigDB]> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigDB.* to "apolloconfig"@"192.168.0.%" identified by "root";
  MariaDB [ApolloConfigDB]> select user,host from mysql.user;
  # 修改初始化数据
  MariaDB [ApolloConfigDB]> select * from serverConfig\G
  MariaDB [ApolloConfigDB]> update ApolloConfigDB.ServerConfig set ServerConfig.Value="http://config.od.com/eureka" where ServerConfig.Key="eureka.service.url";
  
  # 11上解析域名
  [root@hdss7-11 ~]# vi /var/named/od.com.zone
  config             A    192.168.0.10
  [root@hdss7-11 ~]# systemctl restart named
  [root@hdss7-11 ~]# dig -t A config.od.com @192.168.0.11 +short
  192.168.0.10
  # 21上
  [root@hdss7-21 ~]# dig -t A config.od.com @192.168.0.11 +short
  192.168.0.10
  [root@hdss7-21 ~]#  dig -t A config.od.com @10.254.0.2 +short
  192.168.0.10
  ```

### 交付configservice到Kubernetes集群

```shell
# 11上解析域名
[root@hdss7-11 ~]# vi /var/named/od.com.zone
mysql             A    192.168.0.11
[root@hdss7-11 ~]# systemctl restart named
[root@hdss7-11 ~]# dig -t A mysql.od.com @192.168.0.11 +short
192.168.0.11

# 200上
[root@hdss7-200 harbor]# mkdir /data/dockerfile/apollo-configservice
[root@hdss7-200 harbor]# unzip -o /data/apollo-configservice-1.5.1-github.zip -d /data/dockerfile/apollo-configservice
[root@hdss7-200 harbor]# cd /data/dockerfile/apollo-configservice
[root@hdss7-200 apollo-configservice]# rm -rf apollo-configservice-1.5.1-sources.jar
[root@hdss7-200 apollo-configservice]# cd config/
[root@hdss7-200 config]# vi application-github.properties
spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8
spring.datasource.username = apolloconfig
spring.datasource.password = root
[root@hdss7-200 config]# cd ../scripts/
[root@hdss7-200 scripts]# rm -rf shutdown.sh
[root@hdss7-200 scripts]# rm -rf startup.sh
[root@hdss7-200 scripts]# vi startup.sh
# 从官网下载下来
#!/bin/bash
SERVICE_NAME=apollo-configservice
## Adjust log dir if necessary
LOG_DIR=/opt/logs/apollo-config-server
## Adjust server port if necessary
SERVER_PORT=8080
APOLLO_CONFIG_SERVICE_NAME=$(hostname -i)                           # 自己新增的一行
SERVER_URL="http://${APOLLO_CONFIG_SERVICE_NAME}:${SERVER_PORT}"

## Adjust memory settings if necessary                               # 修改点
export JAVA_OPTS="-Xms128m -Xmx128m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=256m -XX:MaxNewSize=256m -XX:SurvivorRatio=8"

## Only uncomment the following when you are using server jvm
#export JAVA_OPTS="$JAVA_OPTS -server -XX:-ReduceInitialCardMarks"

########### The following is the same for configservice, adminservice, portal ###########
export JAVA_OPTS="$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom"
export JAVA_OPTS="$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/"

# Find Java
if [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]]; then
    javaexe="$JAVA_HOME/bin/java"
elif type -p java > /dev/null 2>&1; then
    javaexe=$(type -p java)
elif [[ -x "/usr/bin/java" ]];  then
    javaexe="/usr/bin/java"
else
    echo "Unable to find Java"
    exit 1
fi

if [[ "$javaexe" ]]; then
    version=$("$javaexe" -version 2>&1 | awk -F '"' '/version/ {print $2}')
    version=$(echo "$version" | awk -F. '{printf("%03d%03d",$1,$2);}')
    # now version is of format 009003 (9.3.x)
    if [ $version -ge 011000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    elif [ $version -ge 010000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    elif [ $version -ge 009000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    else
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParNewGC"
        JAVA_OPTS="$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M"
    fi
fi

printf "$(date) ==== Starting ==== \n"

cd `dirname $0`/..
chmod 755 $SERVICE_NAME".jar"
./$SERVICE_NAME".jar" start

rc=$?;

if [[ $rc != 0 ]];
then
    echo "$(date) Failed to start $SERVICE_NAME.jar, return code: $rc"
    exit $rc;
fi

tail -f /dev/null
[root@hdss7-200 scripts]# chmod u+x startup.sh
```

```shell
# Dockerfile 官网
[root@hdss7-200 apollo-configservice]# vi Dockerfile
FROM stanleyws/jre8:8u112

ENV VERSION 1.5.1

RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\
    echo "Asia/Shanghai" > /etc/timezone

ADD apollo-configservice-${VERSION}.jar /apollo-configservice/apollo-configservice.jar
ADD config/ /apollo-configservice/config
ADD scripts/ /apollo-configservice/scripts

CMD ["/apollo-configservice/scripts/startup.sh"]
[root@hdss7-200 apollo-configservice]# docker build . -t harbor.od.com/infra/apollo-configservice:v1.5.1
[root@hdss7-200 apollo-configservice]# docker push harbor.od.com/infra/apollo-configservice:v1.5.1

[root@hdss7-200 apollo-configservice]# mkdir /data/k8s-yaml/apollo-configservice && cd /data/k8s-yaml/apollo-configservice
[root@hdss7-200 apollo-configservice]# vi deployment.yaml
kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: apollo-configservice
  namespace: infra
  labels:
    name: apollo-configservice
spec:
  replicas: 1
  selector:
    matchLabels:
      name: apollo-configservice
  template:
    metadata:
      labels:
        app: apollo-configservice
        name: apollo-configservice
    spec:
      volumes:
      - name: configmap-volume
        configMap:
          name: apollo-configservice-cm
      containers:
      - name: apollo-configservice
        image: harbor.od.com/infra/apollo-configservice:v1.5.1
        ports:
        - containerPort: 8080
          protocol: TCP
        volumeMounts:
        - name: configmap-volume
          mountPath: /apollo-configservice/config
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        imagePullPolicy: IfNotPresent
      imagePullSecrets:
      - name: harbor
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext:
        runAsUser: 0
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  revisionHistoryLimit: 7
  progressDeadlineSeconds: 600
  
[root@hdss7-200 apollo-configservice]# vi configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: apollo-configservice-cm
  namespace: infra
data:
  application-github.properties: |
    # DataSource
    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8
    spring.datasource.username = apolloconfig
    spring.datasource.password = root
    eureka.service.url = http://config.od.com/eureka
  app.properties: |
    appId=100003171
    
[root@hdss7-200 apollo-configservice]# vi svc.yaml
kind: Service
apiVersion: v1
metadata:
  name: apollo-configservice
  namespace: infra
spec:
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  selector:
    app: apollo-configservice
    
[root@hdss7-200 apollo-configservice]# vi ingress.yaml
kind: Ingress
apiVersion: extensions/v1beta1
metadata: 
  name: apollo-configservice
  namespace: infra
spec:
  rules:
  - host: config.od.com
    http:
      paths:
      - path: /
        backend: 
          serviceName: apollo-configservice
          servicePort: 8080
```

```shell
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/configmap.yaml
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/deployment.yaml
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/svc.yaml
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/ingress.yaml
[root@hdss7-22 conf]# curl config.od.com
Bad Gateway[root@hdss7-22 conf]# curl config.od.com
# 稍等下
# 有内容了
# 浏览器访问
http://config.od.com/
```

![image-20200823210425041](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823210425041.png)

```shell
[root@hdss7-22 conf]# curl http://172.7.21.7:8080/info
{"git":{"commit":{"time":{"seconds":1573275854,"nanos":0},"id":"c9eae54"},"branch":"1.5.1"}}[root@hdss7-22 conf]#
```

```shell
# 11上
[root@hdss7-11 ~]# mysql -uroot -p
Enter password:root
MariaDB [(none)]> show processlist;
MariaDB [(none)]> show grants for 'apolloconfig'@'192.168.0.%';
```

### 交付adminservice到Kubernetes集群

```shell
# github 上下载 1.5.1
# 200上
[root@hdss7-200 data]# mkdir /data/dockerfile/apollo-adminservice
[root@hdss7-200 data]# unzip -o /data/apollo-adminservice-1.5.1-github.zip -d  /data/dockerfile/apollo-adminservice
[root@hdss7-200 data]# cd  /data/dockerfile/apollo-adminservice
[root@hdss7-200 apollo-adminservice]# rm -rf apollo-adminservice-1.5.1-sources.jar
[root@hdss7-200 apollo-adminservice]# rm -f apollo-adminservice.conf
[root@hdss7-200 apollo-adminservice]# cd scripts/
[root@hdss7-200 scripts]# rm -rf shutdown.sh
[root@hdss7-200 scripts]# rm -rf startup.sh
[root@hdss7-200 scripts]# vi startup.sh
#!/bin/bash
SERVICE_NAME=apollo-adminservice
## Adjust log dir if necessary
LOG_DIR=/opt/logs/apollo-adminservice
## Adjust server port if necessary
SERVER_PORT=8080                                         # 修改点
APOLLO_ADMIN_SERVICE_NAME=$(hostname -i)                 # 修改点
# SERVER_URL="http://localhost:${SERVER_PORT}"
SERVER_URL="http://${APOLLO_ADMIN_SERVICE_NAME}:${SERVER_PORT}"

## Adjust memory settings if necessary
#export JAVA_OPTS="-Xms2560m -Xmx2560m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=1536m -XX:MaxNewSize=1536m -XX:SurvivorRatio=8"

## Only uncomment the following when you are using server jvm
#export JAVA_OPTS="$JAVA_OPTS -server -XX:-ReduceInitialCardMarks"

########### The following is the same for configservice, adminservice, portal ###########
export JAVA_OPTS="$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom"
export JAVA_OPTS="$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/"

# Find Java
if [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]]; then
    javaexe="$JAVA_HOME/bin/java"
elif type -p java > /dev/null 2>&1; then
    javaexe=$(type -p java)
elif [[ -x "/usr/bin/java" ]];  then
    javaexe="/usr/bin/java"
else
    echo "Unable to find Java"
    exit 1
fi

if [[ "$javaexe" ]]; then
    version=$("$javaexe" -version 2>&1 | awk -F '"' '/version/ {print $2}')
    version=$(echo "$version" | awk -F. '{printf("%03d%03d",$1,$2);}')
    # now version is of format 009003 (9.3.x)
    if [ $version -ge 011000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    elif [ $version -ge 010000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    elif [ $version -ge 009000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    else
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParNewGC"
        JAVA_OPTS="$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M"
    fi
fi

printf "$(date) ==== Starting ==== \n"

cd `dirname $0`/..
chmod 755 $SERVICE_NAME".jar"
./$SERVICE_NAME".jar" start

rc=$?;

if [[ $rc != 0 ]];
then
    echo "$(date) Failed to start $SERVICE_NAME.jar, return code: $rc"
    exit $rc;
fi

tail -f /dev/null

[root@hdss7-200 scripts]# chmod +x startup.sh
[root@hdss7-200 scripts]# cd ..
[root@hdss7-200 apollo-adminservice]# vi Dockerfile
FROM stanleyws/jre8:8u112

ENV VERSION 1.5.1

RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\
    echo "Asia/Shanghai" > /etc/timezone

ADD apollo-adminservice-${VERSION}.jar /apollo-adminservice/apollo-adminservice.jar
ADD config/ /apollo-adminservice/config
ADD scripts/ /apollo-adminservice/scripts

CMD ["/apollo-adminservice/scripts/startup.sh"]
[root@hdss7-200 apollo-adminservice]# docker build . -t harbor.od.com/infra/apollo-adminservice:v1.5.1
[root@hdss7-200 apollo-adminservice]# docker push harbor.od.com/infra/apollo-adminservice:v1.5.1
```

```shell
# 资源配置清单
##200上
[root@hdss7-200 apollo-adminservice]# mkdir /data/k8s-yaml/apollo-adminservice && cd /data/k8s-yaml/apollo-adminservice
[root@hdss7-200 apollo-adminservice]# vi configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: apollo-adminservice-cm
  namespace: infra
data:
  application-github.properties: |
    # DataSource
    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8
    spring.datasource.username = apolloconfig
    spring.datasource.password = root
    eureka.service.url = http://config.od.com/eureka
  app.properties: |
    appId=100003172

[root@hdss7-200 apollo-adminservice]# vi deployment.yaml

kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: apollo-adminservice
  namespace: infra
  labels: 
    name: apollo-adminservice
spec:
  replicas: 1
  selector:
    matchLabels: 
      name: apollo-adminservice
  template:
    metadata:
      labels: 
        app: apollo-adminservice 
        name: apollo-adminservice
    spec:
      volumes:
      - name: configmap-volume
        configMap:
          name: apollo-adminservice-cm
      containers:
      - name: apollo-adminservice
        image: harbor.od.com/infra/apollo-adminservice:v1.5.1
        ports:
        - containerPort: 8080
          protocol: TCP
        volumeMounts:
        - name: configmap-volume
          mountPath: /apollo-adminservice/config
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        imagePullPolicy: IfNotPresent
      imagePullSecrets:
      - name: harbor
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext: 
        runAsUser: 0
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate: 
      maxUnavailable: 1
      maxSurge: 1
  revisionHistoryLimit: 7
  progressDeadlineSeconds: 600  
```

```shell
# 22上
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-adminservice/configmap.yaml
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-adminservice/deployment.yaml
```

![image-20200823215333295](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823215333295.png)

```shell
# 浏览器访问
http://config.od.com/
[root@hdss7-22 conf]# curl http://172.7.21.8:8080/info
{"git":{"commit":{"time":{"seconds":1573275854,"nanos":0},"id":"c9eae54"},"branch":"1.5.1"}}
```

![image-20200823215838624](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823215838624.png)

### 交付portal到Kubernetes集群

```shell
# 200
[root@hdss7-200 apollo-portal]# mkdir /data/dockerfile/apollo-portal
[root@hdss7-200 apollo-portal]# unzip -o /data/apollo-portal-1.5.1-github.zip -d /data/dockerfile/apollo-portal
[root@hdss7-200 apollo-portal]# cd /data/dockerfile/apollo-portal
[root@hdss7-200 apollo-portal]# rm -rf apollo-portal-1.5.1-sources.jar
[root@hdss7-200 apollo-portal]# rm -rf apollo-portal.conf
[root@hdss7-200 apollo-portal]# rm -rf scripts/shutdown.sh
[root@hdss7-200 apollo-portal]# cd config/

# 11上
[root@hdss7-11 ~]# wget https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/db/migration/portaldb/V1.0.0__initialization.sql -o apolloportal.sql
[root@hdss7-11 ~]# mysql -uroot -p
Enter password:root
MariaDB [ApolloPortalDB]> source ./apolloportal.sql
MariaDB [ApolloPortalDB]> show databases;
MariaDB [ApolloPortalDB]> use ApolloPortalDB;
MariaDB [ApolloConfigDB]> show tables;
MariaDB [ApolloConfigDB]> select * from ServerConfig\G;
MariaDB [ApolloConfigDB]> grant INSERT,DELETE,UPDATE,SELECT on ApolloPortalDB.* to "apolloportal"@"192.168.0.%" identified by "root";
MariaDB [ApolloConfigDB]> select user,host from mysql.user;
MariaDB [ApolloPortalDB]> select * from ServerConfig\G;
MariaDB [ApolloPortalDB]> update ServerConfig set Value='[{"orgId":"od01","orgName":"Linux学院"},{"orgId":"od02","orgName":"云计算学院"}]' where Id=2;

# 200上
[root@hdss7-200 apollo-portal]# cd scripts/
[root@hdss7-200 scripts]# rm -rf startup.sh
[root@hdss7-200 scripts]# vi startup.sh
#!/bin/bash
SERVICE_NAME=apollo-portal
## Adjust log dir if necessary
LOG_DIR=/opt/logs/apollo-portal-server
## Adjust server port if necessary
SERVER_PORT=8080                                                # 修改点
APOLLO_PORTAL_SERVICE_NAME=$(hostname -i)                       # 修改点
# SERVER_URL="http://localhost:$SERVER_PORT"
SERVER_URL="http://${APOLLO_PORTAL_SERVICE_NAME}:${SERVER_PORT}"

## Adjust memory settings if necessary
#export JAVA_OPTS="-Xms2560m -Xmx2560m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=1536m -XX:MaxNewSize=1536m -XX:SurvivorRatio=8"

## Only uncomment the following when you are using server jvm
#export JAVA_OPTS="$JAVA_OPTS -server -XX:-ReduceInitialCardMarks"

########### The following is the same for configservice, adminservice, portal ###########
export JAVA_OPTS="$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom"
export JAVA_OPTS="$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/"

# Find Java
if [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]]; then
    javaexe="$JAVA_HOME/bin/java"
elif type -p java > /dev/null 2>&1; then
    javaexe=$(type -p java)
elif [[ -x "/usr/bin/java" ]];  then
    javaexe="/usr/bin/java"
else
    echo "Unable to find Java"
    exit 1
fi

if [[ "$javaexe" ]]; then
    version=$("$javaexe" -version 2>&1 | awk -F '"' '/version/ {print $2}')
    version=$(echo "$version" | awk -F. '{printf("%03d%03d",$1,$2);}')
    # now version is of format 009003 (9.3.x)
    if [ $version -ge 011000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    elif [ $version -ge 010000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    elif [ $version -ge 009000 ]; then
        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"
    else
        JAVA_OPTS="$JAVA_OPTS -XX:+UseParNewGC"
        JAVA_OPTS="$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails"
        JAVA_OPTS="$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M"
    fi
fi

printf "$(date) ==== Starting ==== \n"

cd `dirname $0`/..
chmod 755 $SERVICE_NAME".jar"
./$SERVICE_NAME".jar" start

rc=$?;

if [[ $rc != 0 ]];
then
    echo "$(date) Failed to start $SERVICE_NAME.jar, return code: $rc"
    exit $rc;
fi

tail -f /dev/null
[root@hdss7-200 scripts]# chmod +x startup.sh
[root@hdss7-200 scripts]# cd ..
[root@hdss7-200 apollo-portal]# vi Dockerfile
FROM stanleyws/jre8:8u112

ENV VERSION 1.5.1

RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\
    echo "Asia/Shanghai" > /etc/timezone

ADD apollo-portal-${VERSION}.jar /apollo-portal/apollo-portal.jar
ADD config/ /apollo-portal/config
ADD scripts/ /apollo-portal/scripts

CMD ["/apollo-portal/scripts/startup.sh"]
[root@hdss7-200 apollo-portal]# docker build . -t harbor.od.com/infra/apollo-portal:v1.5.1
[root@hdss7-200 apollo-portal]# docker push harbor.od.com/infra/apollo-portal:v1.5.1
```

```shell
[root@hdss7-200 apollo-adminservice]# mkdir /data/k8s-yaml/apollo-portal && cd /data/k8s-yaml/apollo-portal
[root@hdss7-200 apollo-portal]# vi configmap.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: apollo-portal-cm
  namespace: infra
data:
  application-github.properties: |
    # DataSource
    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloPortalDB?characterEncoding=utf8
    spring.datasource.username = apolloportal
    spring.datasource.password = root
  app.properties: |
    appId=100003173
  apollo-env.properties: |
    dev.meta=http://config.od.com

[root@hdss7-200 apollo-portal]# vi deployment.yaml

kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: apollo-portal
  namespace: infra
  labels: 
    name: apollo-portal
spec:
  replicas: 1
  selector:
    matchLabels: 
      name: apollo-portal
  template:
    metadata:
      labels: 
        app: apollo-portal 
        name: apollo-portal
    spec:
      volumes:
      - name: configmap-volume
        configMap:
          name: apollo-portal-cm
      containers:
      - name: apollo-portal
        image: harbor.od.com/infra/apollo-portal:v1.3.0
        ports:
        - containerPort: 8080
          protocol: TCP
        volumeMounts:
        - name: configmap-volume
          mountPath: /apollo-portal/config
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        imagePullPolicy: IfNotPresent
      imagePullSecrets:
      - name: harbor
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext: 
        runAsUser: 0
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate: 
      maxUnavailable: 1
      maxSurge: 1
  revisionHistoryLimit: 7
  progressDeadlineSeconds: 600
  
[root@hdss7-200 apollo-portal]# vi svc.yaml
kind: Service
apiVersion: v1
metadata:
  name: apollo-portal
  namespace: infra
spec:
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  selector:
    app: apollo-portal
    
[root@hdss7-200 apollo-portal]# vi ingress.yaml    
kind: Ingress
apiVersion: extensions/v1beta1
metadata:
  name: apollo-portal
  namespace: infra
spec:
  rules:
  - host: portal.od.com
    http:
      paths:
      - path: /
        backend:
          serviceName: apollo-portal
          servicePort: 8080    
```

```shell
# 11解析域名
[root@hdss7-11 ~]# vi /var/named/od.com.zone
portal             A    192.168.0.10
[root@hdss7-11 ~]# systemctl restart named
[root@hdss7-11 ~]# dig -t A portal.od.com @192.168.0.11 +short
192.168.0.10

# 22上
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/configmap.yaml
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/deployment.yaml
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/svc.yaml
[root@hdss7-22 conf]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/ingress.yaml

# 浏览器访问
http://portal.od.com/
apollo
admin
# 修改密码：管理员工具-用户管理-apollo admin123
# 管理员工具-系统参数
organizations
[{"orgId":"od01","orgName":"Linux学院"},{"orgId":"od02","orgName":"云计算学院"},{"orgId":"od03","orgName":"Python学院"}]
部门列表
# 新建项目
Linux学院(od01)
dubbo-demo-service
dubbo服务提供者
apollo/apollo
apollo/apollo
```

```shell
# dubbo-demo-service - 新增配置
dubbo.registry
zookeeper://zk1.od.com:2181
dubbo服务的注册中心地址
DEV

dubbo.port
20880
dubbo服务提供者的监听端口
DEV
# dubbo-demo-service - 发布
```

![image-20200824075228445](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200824075228445.png)

## 实战配置dubbo微服务接受Apollo配置中心管理

### 重新构建dubbo服务提供者

```shell
# jenkins
## Pipeline dubbo-demo - Build with paramters
dubbo-demo-service
app/dubbo-demo-service
https://gitee.com/stanleywang/dubbo-demo-service.git
apollo
20200824_0754
./
./dubbo-server/target
mvn clean package -Dmaven.test.skip=true
base/jre8:8u112
3.6.1-8u232

# 200上修改 dubbo-demo-service的deployment.yaml
vi /data/k8s-yaml/dubbo-demo-service/dp.yaml
镜像版本改为：apollo_20200824_0754
env下增加:
- name: C_OPTS
  value: -Denv=dev -Dapollo.meta=http://config.od.com
# 21上
kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-service/dp.yaml  
```

```shell
# dashboard上查看dubbo-demo-service pod的日志，其中打印
apollo.meta configuration: http://config.od.com!
# 刷新apollo的页面，查看dubbo-demo-service项目的实例列表，其中有App ID为dubbo-demo-service的记录，则说明dubbo-service配置Apollo成功
### dubbo-demo-service项目中的resources/META-INF下有app.properties文件，内容为app.id=dubbo-demo-service，和apollo的dubbo-demo-service项目的AppId的值要相同

# 每次在apollo上发布新的配置后，需要删除之前的pod来重新创建新pod应用新配置
```

![image-20200824080953023](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200824080953023.png)

![image-20200824081020077](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200824081020077.png)

![image-20200824081126156](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200824081126156.png)

* 删除pod，重启pod

![image-20200824081233461](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200824081233461.png)

### 重新构建dubbo服务消费者

```shell
# dubbo-demo-web项目中的resources/META-INF下有app.properties文件，内容为app.id=dubbo-demo-web，和apollo的dubbo-demo-web项目的AppId的值要相同

# 创建Apollo的dubbo-demo-web项目
部门：Linux学院（od01）
AppId：dubbo-demo-web
应用名称：dubbo服务消费者
应用负责人：apollo|apollo
项目管理员：apollo|apollo

# 添加配置项
Key:dubbo.registry
Value:zookeeper://zk2.od.com:2181
Comment:dubbo服务消费者注册中心地址
选择集群:DEV
```

```shell
# jenkins中重新构建dubbo服务的消费者
dubbo-demo-consumer
app/dubbo-demo-consumer
https://gitee.com/dyjwoody/dubbo-demo-web.git
apollo                    # gitee分支
20200824_1654
./
./dubbo-client/target
mvn clean package -Dmaven.test.skip=true
base/jre8:8u112s
3.6.1-8u232
```

```shell
# 200上修改deployment.yaml
[root@hdss7-200 harbor]# vi /data/k8s-yaml/dubbo-demo-consumer/deployment.yaml
修改镜像版本:apollo_20200824_1654
env下增加:
- name: C_OPTS
  value: -Denv=dev -Dapollo.meta=http://config.od.com 

# 21上
kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/deployment.yaml
```

![image-20200824082353640](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200824082353640.png)

![image-20200824082412325](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200824082412325.png)

* 每次修改了代码，在Jenkins中需要重新构建配置 Pipeline dubbo-demo
* deployment.yaml中修改镜像版本
* kubectl apply -f /xx/xx.yaml

```shell
# dashboard中  infra - configmap - dubbo-monitor-cm - 修改 zk1或zk2，然后在部署中找到dubbo-monitor，删除其下Pod
# 然后在 dubbo-monitor.od.com  -  Home  -   status中查看 registry是否已经修改过来
# 在apollo中修改dubbo-service和 dubbo-consumer对应的registry，其注册中心要一致，且与configmap中的一致
# 修改完后，删除dubbo-service和 dubbo-consumer的Pod
# 查看dubbo-monitor.od.com中Home - Applications - provider、consumer和monitor是否已起来
## Providers的Used By为Consumer的name
## Consumer的Depends On为Providers的name
## 调用 dubbo-consumer 的接口看看是否能够正常调用 dubbo-service的服务来返回结果
```

## 实战使用Apollo配置中心管理测试环境和生产环境

```shell
# 11上
[root@hdss7-11 ~]# vi /var/named/od.com.zone
zk-test            A    192.168.0.11
zk-prod            A    192.168.0.12
[root@hdss7-11 ~]# systemctl restart named
[root@hdss7-11 ~]# dig -t A zk-test.od.com @192.168.0.11 +short
192.168.0.11
[root@hdss7-11 ~]# dig -t A zk-prod.od.com @192.168.0.11 +short
192.168.0.12

# dashboard上 
dubbo-demo-consumer和dubbo-demo-service 都scale为0

# 21上
[root@hdss7-21 ~]# dig -t A config.od.com @10.254.0.2 +short
192.168.0.10
[root@hdss7-21 ~]# kubectl create ns test
[root@hdss7-21 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n test
[root@hdss7-21 ~]# kubectl create ns prod
[root@hdss7-21 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n prod

# apollo-portal各环境可共用
# apollo-adminservice和apollo-configservice各环境得有自己的一套

# 分环境之前把 apollo-portal、apollo-adminservice和apollo-configservice 都scale为0，否则很卡

# 11上，修改apollo的数据库配置
# Test环境 改为ApolloConfigTestDB
[root@hdss7-11 ~]# vi apolloconfig.sql
CREATE DATABASE IF NOT EXISTS ApolloConfigTestDB DEFAULT CHARACTER SET = utf8mb4;
Use ApolloConfigTestDB;
[root@hdss7-11 ~]# mysql -uroot -p < apolloconfig.sql
[root@hdss7-11 ~]# mysql -uroot -p
Enter password:root
MariaDB [(none)]> show databases;
 ApolloConfigTestDB
MariaDB [(none)]> use ApolloConfigTestDB;
MariaDB [ApolloConfigDBTest]> show tables;
MariaDB [ApolloConfigDBTest]> select * from  ServerConfig\G;
MariaDB [ApolloConfigDBTest]> update ApolloConfigTestDB.ServerConfig set ServerConfig.Value="http://config-test.od.com/eureka" where ServerConfig.Key="eureka.service.url";

# Pord环境 改为ApolloConfigPordDB
[root@hdss7-11 ~]# vi apolloconfig.sql
CREATE DATABASE IF NOT EXISTS ApolloConfigProdDB DEFAULT CHARACTER SET = utf8mb4;
Use ApolloConfigProdDB;
[root@hdss7-11 ~]# mysql -uroot -p < apolloconfig.sql
[root@hdss7-11 ~]# mysql -uroot -p
Enter password:root
MariaDB [(none)]> show databases;
 ApolloConfigProdDB
MariaDB [(none)]> use ApolloConfigProdDB;
MariaDB [ApolloConfigDBTest]> show tables;
MariaDB [ApolloConfigDBTest]> select * from  ServerConfig\G;
MariaDB [ApolloConfigDBTest]> update ApolloConfigProdDB.ServerConfig set ServerConfig.Value="http://config-prod.od.com/eureka" where ServerConfig.Key="eureka.service.url";

MariaDB [ApolloConfigProdDB]> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigTestDB.* to "apolloconfig"@"192.168.0.%" identified by "root";
MariaDB [ApolloConfigProdDB]> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigProdDB.* to "apolloconfig"@"192.168.0.%" identified by "root";

# 添加可支持的环境列表 fat、pro
MariaDB [ApolloConfigProdDB]> use ApolloPortalDB;
MariaDB [ApolloPortalDB]> show tables;
MariaDB [ApolloPortalDB]> select * from ServerConfig\G;
MariaDB [ApolloPortalDB]> update ServerConfig set Value='fat,pro' where Id=1;

# 200上
[root@hdss7-200 harbor]# vi /data/k8s-yaml/apollo-portal/configmap.yaml
# 修改为
  apollo-env.properties: |
    fat.meta=http://config-test.od.com
    pro.meta=http://config-prod.od.com
# 21上
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/configmap.yaml
```

![image-20200824210441503](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200824210441503.png)

```shell
# 200上
[root@hdss7-200 /]# cd /data/k8s-yaml/
[root@hdss7-200 k8s-yaml]# mkdir -pv test/{apollo-configserver,apollo-adminservice,dubbo-demo-service,dubbo-demo-consumer}
[root@hdss7-200 k8s-yaml]# mkdir -pv prod/{apollo-configserver,apollo-adminservice,dubbo-demo-service,dubbo-demo-consumer}
[root@hdss7-200 k8s-yaml]# cd test/
[root@hdss7-200 test]# mv apollo-configserver/ apollo-configservice
[root@hdss7-200 test]# cd apollo-configservice/
[root@hdss7-200 apollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/configmap.yaml  .
[root@hdss7-200 apollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/deployment.yaml  .
[root@hdss7-200 apollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/svc.yaml  .
[root@hdss7-200 apollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/ingress.yaml  .
[root@hdss7-200 apollo-configservice]# vi configmap.yaml
# 修改点
namespace: test
ApolloConfigTestDB
config-test
[root@hdss7-200 apollo-configservice]# vi deployment.yaml
# 修改点
namespace: test
[root@hdss7-200 apollo-configservice]# vi svc.yaml
# 修改点
namespace: test
[root@hdss7-200 apollo-configservice]# vi ingress.yamls
# 修改点
namespace: test
config-test.od.com

# 11上解析DNS
[root@hdss7-11 ~]# vi /var/named/od.com.zone
config-test        A    192.168.0.10
config-prod        A    192.168.0.10
[root@hdss7-11 ~]# systemctl restart named

# 21上
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-configservice/configmap.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-configservice/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-configservice/svc.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-configservice/ingress.yaml

# 200上
[root@hdss7-200 k8s-yaml]# cd /data/k8s-yaml/prod/
[root@hdss7-200 prod]# mv apollo-configserver/ apollo-configservice
[root@hdss7-200 prod]# cd apollo-configservice/
[root@hdss7-200 apollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/configmap.yaml  .
[root@hdss7-200 apollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/deployment.yaml  .
[root@hdss7-200 apollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/svc.yaml  .
[root@hdss7-200 apollo-configservice]# cp -a /data/k8s-yaml/apollo-configservice/ingress.yaml  .
[root@hdss7-200 apollo-configservice]# vi configmap.yaml
# 修改点
namespace: prod
ApolloConfigProdDB
config-prod
[root@hdss7-200 apollo-configservice]# vi deployment.yaml
# 修改点
namespace: prod
[root@hdss7-200 apollo-configservice]# vi svc.yaml
# 修改点
namespace: prod
[root@hdss7-200 apollo-configservice]# vi ingress.yaml
# 修改点
namespace: prod
config-prod.od.com

# 21上
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-configservice/configmap.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-configservice/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-configservice/svc.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-configservice/ingress.yaml
```

```shell
http://config.od.com/已经不能访问
# 可以访问
http://config-test.od.com/
http://config-prod.od.com/
```

```shell
# 200上
[root@hdss7-200 apollo-configservice]# cd /data/k8s-yaml/test/apollo-adminservice/
[root@hdss7-200 apollo-adminservice]# cp -a /data/k8s-yaml/apollo-adminservice/*.yaml .
[root@hdss7-200 apollo-adminservice]# vi configmap.yaml
# 修改点
namespace: test
ApolloConfigTestDB
config-test
[root@hdss7-200 apollo-adminservice]# vi deployment.yaml
# 修改点
namespace: test

[root@hdss7-200 apollo-configservice]# cd /data/k8s-yaml/prod/apollo-adminservice/
[root@hdss7-200 apollo-adminservice]# cp -a /data/k8s-yaml/apollo-adminservice/*.yaml .
[root@hdss7-200 apollo-adminservice]# vi configmap.yaml
# 修改点
namespace: prod
ApolloConfigProdDB
config-prod
[root@hdss7-200 apollo-adminservice]# vi deployment.yaml
# 修改点
namespace: prod

# 21上
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-adminservice/configmap.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/apollo-adminservice/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-adminservice/configmap.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/apollo-adminservice/deployment.yaml
```

```shell
# 因为是共用一套portal，所以需要先清空之前的数据
[root@hdss7-11 ~]# mysql -uroot -p
MariaDB [(none)]> show databases;
MariaDB [ApolloConfigDB]> use ApolloPortalDB;
MariaDB [ApolloPortalDB]> truncate table AppNamespace;
MariaDB [ApolloPortalDB]> truncate table App;
```

```shell
# dashboard中
infra的namespace中apollo-portal scale 为 1
# 浏览器
http://portal.od.com/
apollo
admin123
# 管理员工具-系统参数-查询key apollo.portal.envs  有值为fat,pro，则成功
```

```shell
# 创建apollo项目
部门：云计算学院(od02)
AppId：dubbo-demo-service
应用名称：dubbo服务提供者
应用负责人：apollo|apollo
项目管理员：apollo|apollo

# 添加配置项
Key：dubbo.registry
Value：zookeeper://zk-test.od.com:2181
Comment：测试环境dubbo服务提供者注册中心地址
选择集群：FAT

# 添加配置项
Key：dubbo.port
Value：20880
Comment：测试环境dubbo服务提供者监听端口号
选择集群：FAT

# 发布

# 右侧选择 PRO

# 添加配置项
Key：dubbo.registry
Value：zookeeper://zk-prod.od.com:2181
Comment：生产环境dubbo服务提供者注册中心地址
选择集群：PRO

# 添加配置项
Key：dubbo.port
Value：20880
Comment：生产环境dubbo服务提供者监听端口号
选择集群：PRO

# 发布

# 创建apollo项目
部门：云计算学院(od02)
AppId：dubbo-demo-web
应用名称：dubbo服务消费者
应用负责人：apollo|apollo
项目管理员：apollo|apollo

# 添加配置项
Key：dubbo.registry
Value：zookeeper://zk-test.od.com:2181
Comment：测试环境dubbo服务提供者注册中心地址
选择集群：FAT

# 发布

# 右侧选择PRO
# 添加配置项
Key：dubbo.registry
Value：zookeeper://zk-prod.od.com:2181
Comment：生产环境dubbo服务提供者注册中心地址
选择集群：PRO

# 发布
```

```shell
# 200
[root@hdss7-200 harbor]# cd /data/k8s-yaml/test/dubbo-demo-service/
[root@hdss7-200 dubbo-demo-service]# cp -a /data/k8s-yaml/dubbo-demo-service/*.yaml .
[root@hdss7-200 dubbo-demo-service]# vi dp.yaml
# 修改点
namespace: test
value: -Denv=fat -Dapollo.meta=http://config-test.od.com

# 21上
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-service/dp.yaml

# http://dubbo-monitor.od.com/
registry zk1.od.com:2181(connected)

# dashboard
namespace:infra 
ConfigMaps:dubbo-monitor-cm改为zk-test.od.com:2181
删除dubbo-monitor Pod
# http://dubbo-monitor.od.com/中 变为
registry zk-test.od.com:2181(connected)
```

```shell
# 200
[root@hdss7-200 harbor]# cd /data/k8s-yaml/test/dubbo-demo-consumer/
[root@hdss7-200 dubbo-demo-service]# cp -a /data/k8s-yaml/dubbo-demo-consumer/*.yaml .
[root@hdss7-200 dubbo-demo-service]# vi deployment.yaml
# 修改点
namespace: test
value: -Denv=fat -Dapollo.meta=http://config-test.od.com
[root@hdss7-200 dubbo-demo-consumer]# vi svc.yaml
# 修改点
namespace: test
[root@hdss7-200 dubbo-demo-consumer]# vi ingress.yaml
# 修改点
namespace: test
host: demo-test.od.com

# 11解析域名
[root@hdss7-11 ~]# vi /var/named/od.com.zone
demo-test          A    192.168.0.10
[root@hdss7-11 ~]# systemctl restart named

# 21上
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-consumer/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-consumer/svc.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/test/dubbo-demo-consumer/ingress.yaml
```

![image-20200826204730307](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200826204730307.png)

![image-20200826204820044](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200826204820044.png)

```shell
# 11上解析域名
[root@hdss7-11 ~]# vi /var/named/od.com.zone
demo-prod          A    192.168.0.10
[root@hdss7-11 ~]# systemctl restart named

# 200
[root@hdss7-200 harbor]# cd /data/k8s-yaml/prod/dubbo-demo-service/
[root@hdss7-200 dubbo-demo-service]# cp -a /data/k8s-yaml/dubbo-demo-service/*.yaml .
[root@hdss7-200 dubbo-demo-service]# vi dp.yaml
# 修改点
namespace: prod
value: -Denv=pro -Dapollo.meta=http://apollo-configservice:8080
# dubbo-demo-service 和 apollo-configservice 在同一个namespace，相互之间可以直接通过名称找到
[root@hdss7-21 ~]# kubectl get svc -n test
NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
apollo-configservice   ClusterIP   10.254.93.80   <none>        8080/TCP   24h
dubbo-demo-consumer    ClusterIP   10.254.198.6   <none>        8080/TCP   17m
[root@hdss7-21 ~]# dig -t A apollo-configservice.test.svc.cluster.local. @10.254.0.2 +short
10.254.93.80

# 21上
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-service/dp.yaml
```

```shell
# 200
[root@hdss7-200 harbor]# cd /data/k8s-yaml/prod/dubbo-demo-consumer/
[root@hdss7-200 dubbo-demo-service]# cp -a /data/k8s-yaml/dubbo-demo-consumer/*.yaml .
[root@hdss7-200 dubbo-demo-service]# vi deployment.yaml
# 修改点
namespace: prod
value: -Denv=pro -Dapollo.meta=http://apollo-configservice:8080
[root@hdss7-200 dubbo-demo-consumer]# vi svc.yaml
# 修改点
namespace: prod
[root@hdss7-200 dubbo-demo-consumer]# vi ingress.yaml
# 修改点
namespace: prod
host: demo-prod.od.com

# 11解析域名
[root@hdss7-11 ~]# vi /var/named/od.com.zone
demo-prod          A    192.168.0.10
[root@hdss7-11 ~]# systemctl restart named

# 21上
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-consumer/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-consumer/svc.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prod/dubbo-demo-consumer/ingress.yaml
```

![image-20200826210915415](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200826210915415.png)

## 发版流程

* dubbo-demo-web的apollo分支修改代码并提交，记住commitId前8位

* Jenkins上构建对应pipeline，git_ver为commitId前8位，Jenkins构建完后，获取

  ![image-20200826211859674](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200826211859674.png)

* dashboard的test的namespace中的Deployment中的dubbo-demo-consumer，修改其YAML中镜像版本为Jenkins构建完后显示的那几位字符

* 查看对应Pod的日志

* 刷新test环境页面

* test环境验证没问题后

* （测试环境和生产环境共用一个docker镜像）

* dashboard中修改prod的namespace中的Deployment中的dubbo-demo-consumer，修改其YAML中镜像版本为Jenkins构建完后显示的那几位字符

* 查看对应Pod的日志

* 刷新Prod环境页面

