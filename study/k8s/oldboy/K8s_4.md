# K8S中集成Apollo配置中心

![image-20200823123719439](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823123719439.png)

![image-20200823124905367](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823124905367.png)

![image-20200823124925532](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823124925532.png)

![image-20200823125154898](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823125154898.png)

![image-20200823125528285](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823125528285.png)



## ConfigMap管理应用配置

```shell
# 拆分环境
HDSS7-11.host.com		zk1.od.com(Test环境) 	192.168.0.11
HDSS7-12.host.com   zk2.od.com(Prod环境)  192.168.0.12

# dashboard上将dubbo-demo-service、dubbo-demo-consumer、dubbo-monitor设置scale为0

# 拆分zk集群
## 停止21上zk
[root@hdss7-21 bin]# /opt/zookeeper/bin/zkServer.sh stop
## 11、12上
[root@hdss7-12 bin]# /opt/zookeeper/bin/zkServer.sh stop
[root@hdss7-11 logs]# ps aux|grep zoo
root     24934  0.0  0.0 112824   980 pts/0    S+   13:12   0:00 grep --color=auto zoo
[root@hdss7-11 zookeeper]# cd /data/zookeeper
[root@hdss7-11 zookeeper]# rm -rf data/*
[root@hdss7-11 zookeeper]# rm -rf logs/*
[root@hdss7-11 zookeeper]# cd /opt/zookeeper/conf/
[root@hdss7-11 conf]# vi zoo.cfg
tickTime=2000
initLimit=10
syncLimit=5
dataDir=/data/zookeeper/data
dataLogDir=/data/zookeeper/logs
clientPort=2181
[root@hdss7-11 conf]# ../bin/zkServer.sh start
[root@hdss7-11 conf]# ../bin/zkServer.sh status
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/bin/../conf/zoo.cfg
Mode: standalone

# 200上
[root@hdss7-200 dubbo-monitor]# cd /data/k8s-yaml/dubbo-monitor
[root@hdss7-200 dubbo-monitor]# vi /data/k8s-yaml/dubbo-monitor/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dubbo-monitor-cm
  namespace: infra
data:
  dubbo.properties: |
    dubbo.container=log4j,spring,registry,jetty
    dubbo.application.name=simple-monitor
    dubbo.application.owner=OldboyEdu
    dubbo.registry.address=zookeeper://zk1.od.com:2181
    dubbo.protocol.port=20880
    dubbo.jetty.port=8080
    dubbo.jetty.directory=/dubbo-monitor-simple/monitor
    dubbo.charts.directory=/dubbo-monitor-simple/charts
    dubbo.statistics.directory=/dubbo-monitor-simple/statistics
    dubbo.log4j.file=/dubbo-monitor-simple/logs/dubbo-monitor.log
    dubbo.log4j.level=WARN
    
[root@hdss7-200 dubbo-monitor]# vi /data/k8s-yaml/dubbo-monitor/deployment2.yaml    

kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: dubbo-monitor
  namespace: infra
  labels: 
    name: dubbo-monitor
spec:
  replicas: 1
  selector:
    matchLabels: 
      name: dubbo-monitor
  template:
    metadata:
      labels: 
        app: dubbo-monitor
        name: dubbo-monitor
    spec:
      containers:
      - name: dubbo-monitor
        image: harbor.od.com/infra/dubbo-monitor:latest
        ports:
        - containerPort: 8080
          protocol: TCP
        - containerPort: 20880
          protocol: TCP
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - name: configmap-volume
            mountPath: /dubbo-monitor-simple/conf
      volumes:
        - name: configmap-volume
          configMap:
            name: dubbo-monitor-cm
      imagePullSecrets:
      - name: harbor
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext: 
        runAsUser: 0
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate: 
      maxUnavailable: 1
      maxSurge: 1
  revisionHistoryLimit: 7
  progressDeadlineSeconds: 600

[root@hdss7-200 dubbo-monitor]# vimdiff deployment.yaml deployment2.yaml
[root@hdss7-200 dubbo-monitor]# mv deployment2.yaml deployment.yaml

# 21上
[root@hdss7-21 bin]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/configmap.yaml
```

![image-20200823133052871](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133052871.png)

```shell
[root@hdss7-21 bin]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/deployment.yaml
```

![image-20200823133340714](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133340714.png)

![image-20200823133543522](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133543522.png)

![image-20200823133637250](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133637250.png)

![image-20200823133845102](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823133845102.png)

* dashboard中修改ConfigMap，zookeeper://zk1.od.com:2181为zookeeper://zk2.od.com:2181
* dashboard 容器组中删除dubbo-monitor

![image-20200823134108383](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823134108383.png)

## 排查页面访问不了

```shell
# 排查页面访问不了
tail -fn 200 /var/log/traefik_access.log | grep -i dubbo-monitor
```

![image-20200823134903897](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823134903897.png)

![image-20200823135316420](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823135316420.png)

![image-20200823135821411](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823135821411.png)

![image-20200823140533432](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823140533432.png)

* etcd中key添加上

![image-20200823140739137](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823140739137.png)

![image-20200823140930382](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823140930382.png)

![image-20200823141133417](/Users/dingyuanjie/Documents/study/github/woodyprogram/img/image-20200823141133417.png)

